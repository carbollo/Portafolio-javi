<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | Javier Filmmaker</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600&family=Syncopate:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background: #050505;
            color: #fff;
            padding: 2rem;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            font-family: 'Syncopate', sans-serif;
            color: #00d2ff;
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: #ccc;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px;
            background: #111;
            border: 1px solid #333;
            color: #fff;
            font-family: inherit;
        }

        button {
            background: #00d2ff;
            color: #000;
            padding: 15px 30px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 1rem;
        }

        button:hover {
            background: #fff;
        }

        .preview {
            margin-top: 3rem;
            border-top: 1px solid #333;
            padding-top: 2rem;
        }

        .success-msg {
            color: #0f0;
            display: none;
            margin-top: 1rem;
        }

        /* Auth Overlay */
        #auth-overlay {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
    </style>
</head>

<body>

    <div id="auth-overlay">
        <h2>JAVIER ADMIN</h2>
        <input type="password" id="password" placeholder="Enter Password" style="width: 200px; margin: 1rem 0;">
        <button onclick="checkPass()">Login</button>
    </div>

    <div class="container">
        <h1>New Project</h1>

        <form id="projectForm">
            <div class="form-group">
                <label>Category</label>
                <select id="category" required>
                    <option value="Moda">Moda</option>
                    <option value="Conciertos">Conciertos</option>
                    <option value="Gastronomia">Gastronomia</option>
                    <option value="Creativo">Creativo</option>
                    <option value="Otros">Otros</option>
                </select>
            </div>

            <div class="form-group">
                <label>Project Title</label>
                <input type="text" id="title" required>
            </div>

            <div class="form-group">
                <label>Description</label>
                <textarea id="description" rows="4"></textarea>
            </div>

            <div class="form-group">
                <label>Main Thumbnail (Image File)</label>
                <input type="file" id="thumbnail" accept="image/*" required>
            </div>

            <div class="form-group">
                <label>Gallery Images (Select multiple)</label>
                <input type="file" id="gallery" multiple accept="image/*">
            </div>

            <button type="submit">Save Project</button>
            <div class="success-msg">Project Saved Successfully!</div>
        </form>
    </div>

    </div>

    <!-- Project History Section -->
    <div class="container" style="margin-top: 4rem; border-top: 1px solid #333; padding-top: 3rem;">
        <h1>Project History</h1>

        <div class="form-group">
            <label>Filter by Category</label>
            <select id="filterCategory">
                <option value="">All Categories</option>
                <option value="Moda">Moda</option>
                <option value="Conciertos">Conciertos</option>
                <option value="Gastronomia">Gastronomia</option>
                <option value="Creativo">Creativo</option>
                <option value="Otros">Otros</option>
            </select>
            <button onclick="loadHistory()" style="margin-top: 10px;">Refresh List</button>
        </div>

        <div id="projectList" class="project-list">
            <!-- Items loaded dynamically -->
        </div>
    </div>

    <style>
        .project-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 2rem;
        }

        .project-item {
            background: #111;
            border: 1px solid #333;
            padding: 10px;
            position: relative;
        }

        .project-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            margin-bottom: 10px;
        }

        .project-item h4 {
            font-size: 0.9rem;
            margin: 0 0 5px 0;
            color: #fff;
        }

        .project-item p {
            font-size: 0.7rem;
            color: #999;
            margin: 0 0 10px 0;
        }

        .delete-btn {
            background: #ff3333;
            color: #fff;
            width: 100%;
            padding: 8px;
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .delete-btn:hover {
            background: #cc0000;
        }
    </style>

    <script>
        function checkPass() {
            const pass = document.getElementById('password').value;
            // Simple client-side check (Not secure, but sufficient for basic obscuring)
            if (pass === 'javier123') {
                document.getElementById('auth-overlay').style.display = 'none';
                loadHistory(); // Load initial history
            } else {
                alert('Wrong password');
            }
        }

        document.getElementById('projectForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const button = e.target.querySelector('button');
            button.disabled = true;
            button.textContent = 'Uploading...';

            try {
                // 1. Upload Images Directly to Cloudinary (Bypassing Vercel Limit)
                const thumbInput = document.getElementById('thumbnail');
                const galleryInput = document.getElementById('gallery');

                let thumbPath = '';
                let galleryPaths = [];

                // Helper: Upload a single file
                const uploadToCloudinary = async (file) => {
                    // Get signature
                    const signRes = await fetch('/api/sign-upload');
                    if (!signRes.ok) {
                        const errData = await signRes.json().catch(() => ({}));
                        throw new Error(errData.error || 'Failed to get upload signature (Status ' + signRes.status + ')');
                    }
                    const signData = await signRes.json();

                    // Prepare FormData
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('api_key', signData.api_key);
                    formData.append('timestamp', signData.timestamp);
                    formData.append('signature', signData.signature);
                    formData.append('folder', 'portfolio');

                    // Upload
                    const cloudRes = await fetch(`https://api.cloudinary.com/v1_1/${signData.cloud_name}/auto/upload`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!cloudRes.ok) throw new Error('Cloudinary upload failed');
                    const cloudData = await cloudRes.json();
                    return cloudData.secure_url;
                };

                if (thumbInput.files.length > 0) {
                    button.textContent = 'Uploading Thumbnail...';
                    thumbPath = await uploadToCloudinary(thumbInput.files[0]);
                }

                if (galleryInput.files.length > 0) {
                    for (let i = 0; i < galleryInput.files.length; i++) {
                        button.textContent = `Uploading Gallery (${i + 1}/${galleryInput.files.length})...`;
                        const url = await uploadToCloudinary(galleryInput.files[i]);
                        galleryPaths.push(url);
                    }
                }

                // 2. Save Project
                const project = {
                    title: document.getElementById('title').value,
                    category: document.getElementById('category').value,
                    description: document.getElementById('description').value,
                    thumbnail: thumbPath,
                    gallery: galleryPaths
                };

                const res = await fetch('/api/projects', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(project)
                });

                if (res.ok) {
                    document.querySelector('.success-msg').textContent = 'Project & Images Saved Successfully!';
                    document.querySelector('.success-msg').style.display = 'block';
                    e.target.reset();
                    setTimeout(() => document.querySelector('.success-msg').style.display = 'none', 3000);
                    loadHistory(); // Refresh list after save
                } else {
                    const errorDate = await res.json();
                    throw new Error(errorDate.error || 'Server responded with ' + res.status);
                }
            } catch (err) {
                console.error(err);
                // Try to show specific error from server if available
                let msg = 'Error uploading project';
                if (err.message) msg += ': ' + err.message;
                alert(msg);
            } finally {
                button.disabled = false;
                button.textContent = 'Save Project';
            }
        });

        // History Logic
        document.getElementById('filterCategory').addEventListener('change', loadHistory);

        async function loadHistory() {
            const category = document.getElementById('filterCategory').value;
            const container = document.getElementById('projectList');
            container.innerHTML = '<p style="grid-column: 1/-1;">Loading...</p>';

            try {
                let url = '/api/projects';
                if (category) url += `?category=${category}`;

                const res = await fetch(url);
                const projects = await res.json();

                container.innerHTML = '';

                if (projects.length === 0) {
                    container.innerHTML = '<p style="grid-column: 1/-1;">No projects found.</p>';
                    return;
                }

                projects.forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'project-item';

                    // Helper to fix Drive links (Same as frontend, but for admin view)
                    const fixUrl = (url) => {
                        if (url && url.includes('drive.google.com') && (url.includes('/view') || url.includes('/preview'))) {
                            return url.replace(/\/file\/d\/(.+)\/(view|preview).*/, '/uc?export=view&id=$1');
                        }
                        return url || 'https://via.placeholder.com/150';
                    };
                    const thumb = p.thumbnail ? fixUrl(p.thumbnail) : 'https://via.placeholder.com/150';

                    div.innerHTML = `
                        <img src="${thumb}" alt="${p.title}">
                        <h4>${p.title}</h4>
                        <p>${p.category}</p>
                        <button class="delete-btn" onclick="deleteProject('${p.id}')">DELETE</button>
                    `;
                    container.appendChild(div);
                });

            } catch (err) {
                console.error(err);
                container.innerHTML = '<p style="color:red; grid-column: 1/-1;">Error loading history.</p>';
            }
        }

        async function deleteProject(id) {
            if (!confirm('Are you sure you want to delete this project? This cannot be undone.')) return;

            try {
                const res = await fetch(`/api/projects/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    loadHistory(); // Refresh list
                } else {
                    alert('Failed to delete project');
                }
            } catch (err) {
                console.error(err);
                alert('Error deleting project');
            }
        }
    </script>
</body>

</html>